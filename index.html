<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#fefdfb" />
        <title>Study Notes</title>
        <link rel="manifest" href="manifest.json" />
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <!-- Unified Top Bar -->
        <header class="top-bar">
            <input type="file" id="fileInput" accept=".json" hidden />

            <!-- Left: File actions -->
            <div class="header-section">
                <button id="importBtn" class="action-btn">
                    <svg
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                        />
                    </svg>
                    Open
                </button>
                <button id="exportBtn" class="action-btn">
                    <svg
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"
                        />
                    </svg>
                    Export
                </button>
            </div>

            <!-- Center: Document info -->
            <div class="header-section header-info">
                <span id="topicTitle" class="topic-title">No notes loaded</span>
            </div>

            <!-- Right: Options and mode toggle -->
            <div class="header-section">
                <label class="toggle-option">
                    <input type="checkbox" id="toggleTooltips" />
                    <span class="toggle-label">Tooltips</span>
                </label>
                <label class="toggle-option">
                    <input type="checkbox" id="togglePaths" />
                    <span class="toggle-label">Paths</span>
                </label>
            </div>

            <div class="header-section mode-toggle">
                <button class="mode-btn" data-mode="exam">
                    <svg
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                        />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="9" y1="15" x2="15" y2="15" />
                    </svg>
                    Exam
                </button>
                <button class="mode-btn active" data-mode="full">
                    <svg
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                        <path
                            d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                        />
                    </svg>
                    Full
                </button>
            </div>
        </header>

        <!-- Paper Sheet -->
        <main class="paper-sheet">
            <!-- 3-hole punch -->
            <div class="holes">
                <span class="hole"></span>
                <span class="hole"></span>
                <span class="hole"></span>
            </div>

            <!-- Margin line (vertical) -->
            <div class="margin-line"></div>

            <!-- Content area with horizontal rules -->
            <article
                id="noteContent"
                class="note-content"
                contenteditable="true"
            >
                <!-- Content blocks will be injected here -->
            </article>
        </main>

        <!-- Legend/Help Button -->
        <button id="legendBtn" class="legend-btn" aria-label="Show legend">
            <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
            >
                <circle cx="12" cy="12" r="10" />
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </svg>
        </button>

        <!-- Legend Modal -->
        <div id="legendModal" class="legend-modal">
            <div class="legend-content">
                <div class="legend-header">
                    <h3>üìñ Reading Guide</h3>
                    <button class="legend-close" onclick="closeLegend()">
                        √ó
                    </button>
                </div>
                <div class="legend-body">
                    <div class="legend-section">
                        <h4>Visual Guide</h4>
                        <div class="legend-item">
                            <span class="legend-sample key-sentence"
                                >Yellow highlight</span
                            >
                            <span class="legend-desc"
                                >Important to remember</span
                            >
                        </div>
                        <div class="legend-item">
                            <span class="legend-sample exam-critical-sample"
                                >‚ö° Lightning badge</span
                            >
                            <span class="legend-desc"
                                >Exam critical content</span
                            >
                        </div>
                    </div>

                    <div class="legend-section">
                        <h4>Study Modes</h4>
                        <div class="legend-item">
                            <span class="legend-sample">üìù Exam Mode</span>
                            <span class="legend-desc"
                                >Only ‚ö° content shown</span
                            >
                        </div>
                        <div class="legend-item">
                            <span class="legend-sample">üìö Full Mode</span>
                            <span class="legend-desc">All content shown</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
        <script src="app.js?v=2.1.1"></script>
        <script>
            // Clear cache utility - call clearAppCache() in console if you need to force reload
            window.clearAppCache = async function () {
                console.log("üßπ Clearing all caches...");

                // Unregister service worker
                if ("serviceWorker" in navigator) {
                    const registrations =
                        await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log("‚úÖ Service Worker unregistered");
                    }
                }

                // Clear all caches
                if ("caches" in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) {
                        await caches.delete(name);
                        console.log("‚úÖ Deleted cache:", name);
                    }
                }

                // Clear localStorage (optional - uncomment if needed)
                // localStorage.clear();
                // console.log('‚úÖ LocalStorage cleared');

                console.log("‚úÖ All caches cleared! Reloading page...");
                setTimeout(() => window.location.reload(true), 500);
            };

            // Register Service Worker with update detection
            if (
                "serviceWorker" in navigator &&
                window.location.protocol !== "file:"
            ) {
                navigator.serviceWorker
                    .register("sw.js")
                    .then((reg) => {
                        console.log("‚úÖ Service Worker registered");
                        console.log(
                            "üí° Tip: Run clearAppCache() in console to force refresh all caches",
                        );

                        // Check for updates every 60 seconds
                        setInterval(() => {
                            reg.update();
                        }, 60000);

                        // Detect when new version is available
                        reg.addEventListener("updatefound", () => {
                            const newWorker = reg.installing;

                            newWorker.addEventListener("statechange", () => {
                                if (
                                    newWorker.state === "installed" &&
                                    navigator.serviceWorker.controller
                                ) {
                                    // New version available
                                    if (
                                        confirm(
                                            "üéâ New version available! Reload to update?",
                                        )
                                    ) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((err) => console.log("SW error", err));
            }
        </script>
    </body>
</html>
